Replit Agent Refactor Instructions (Shopify app)
Objective

Refactor storefront experimentation from DOM manipulation to Theme App Extension slots:

No ScriptTags

No theme file edits

Render experiments only inside owned App Blocks

Admin UI controls experiments via backend config

Storefront runtime reads config and renders A/B variant content in slot(s)

Target Architecture

Theme App Extension

App Embed: loads runtime.js site-wide (tiny bootstrap only).

App Block: ExperimentSlot for PDP/Home/Collection (start with PDP). Block outputs a container with stable attributes (e.g., data-cro-slot="pdp").

Config-driven runtime

Storefront runtime.js fetches JSON config for active experiments and renders content inside the slot container.

Measurement

Minimal: record slot_view + atc (optional) + purchase via webhook.

Associate events with experiment_id and variant.

Step-by-step tasks
1) Remove/disable old injection

Delete/stop creating ScriptTags.

Remove any DOM selector-based experiment code paths.

Ensure uninstall cleanup no longer relies on removing injected snippets/scripts.

2) Add Theme App Extension

Create a theme app extension in the repo (use Shopify CLI conventions).

Add:

App Embed: “CRO Runtime”

Includes <script src="{{ 'runtime.js' | asset_url }}" defer></script>

App Block: “Experiment Slot”

Minimal Liquid:

<div id="cro-slot" data-cro-slot="{{ block.settings.slot_id }}"></div>

Block settings:

slot_id default "pdp" (later: "home", "collection")

3) Storefront runtime rendering (no DOM manipulation)

Implement runtime.js with:

Generate stable visitor id cro_vid in localStorage (fallback cookie).

Deterministic variant assignment:

If experiment has allocation: 0.5, bucket by hash(cro_vid) to "A"/"B".

Persist assignment per experiment_id in localStorage.

Fetch config:

GET /apps/cro-proxy/config (App Proxy endpoint) returning JSON:

{ experiments: [{ id, status, slot_id, allocation, variants: { A: {...}, B: {...} } }] }

For each active experiment:

Find matching container: [data-cro-slot="<slot_id>"]

Render variant content only inside container (innerHTML or DOM nodes).

Fire tracking beacon:

POST /apps/cro-proxy/event with { experiment_id, variant, event_type:"slot_view", cro_vid, path }

4) Backend endpoints (App Proxy)

Add routes:

GET /apps/cro-proxy/config

Auth by shop domain + HMAC per app proxy rules.

Return active experiments for that shop.

POST /apps/cro-proxy/event

Validate HMAC.

Persist event row.

5) Minimal Admin UI changes

Update admin UI to control experiments via DB (not theme settings):

Create/Update experiment:

status: DRAFT | LIVE | PAUSED

slot_id: "pdp"

allocation: 0.5

variants.A and variants.B (text payload for the module)

“Launch” sets status=LIVE.

Results page shows counts by variant from events.

6) Webhooks for purchases

Ensure orders/create webhook:

Lookup latest assignment for cro_vid is hard; for MVP, record purchase without visitor join:

Either:

(Preferred) Store cro_vid in cart attributes at add-to-cart (if you implement ATC capture), then read it from the order.

(Simpler demo) Count purchases overall by experiment window (time-based) and mark as “demo attribution.”

Implement app/uninstalled webhook to delete shop data.

7) Onboarding UX

Add a simple checklist page:

Deep-link to enable App Embed (runtime)

Deep-link to add Experiment Slot block to PDP template

Detect and display status:

Embed enabled? (best-effort; otherwise provide “Continue”)

Slot present? (you can’t reliably detect without storefront ping; ok to instruct)

Acceptance Criteria (must pass)

No ScriptTags created/used anywhere.

Merchant adds app embed + PDP slot block once.

Clicking “Launch test” in admin sets experiment LIVE.

Visiting a product page shows Variant A or B rendered inside the slot.

Refresh in another browser shows deterministic assignment.

Admin dashboard shows event counts by variant.

Constraints

Do not attempt to edit theme files via Admin API.

Do not manipulate existing theme DOM outside the slot.

Keep runtime.js lightweight and resilient (no external dependencies).