(function(){'use strict';const V='2.0.0',SK='cro_vid',AK='cro_assignments';let cfg={apiUrl:'',shop:''},vid=null,asgn={},isPM=false,pTok=null;
function chkPM(){const p=new URLSearchParams(location.search),t=p.get('shoptimizer_preview');if(t){console.log('[CRO] Preview:',t);isPM=true;pTok=t;return true}return false}
function init(){console.log('[CRO] v'+V);chkPM();cfg.shop=getShop();if(!cfg.shop){console.warn('[CRO] No shop');return}vid=isPM?'preview-'+pTok:getVid();console.log('[CRO] vid:',vid);if(!isPM)asgn=ldAsgn();fetchCfg()}
function getShop(){const m=document.querySelector('meta[name="shopify-shop-domain"]');if(m)return m.content;if(window.Shopify?.shop)return Shopify.shop;const s=document.querySelector('[data-cro-slot]');if(s?.dataset.shop)return s.dataset.shop;const h=location.hostname;if(h.includes('.myshopify.com'))return h;return null}
function genVid(){if(crypto?.randomUUID)return crypto.randomUUID();return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16)})}
function getVid(){try{let v=localStorage.getItem(SK);if(v)return v;v=genVid();localStorage.setItem(SK,v);return v}catch(e){const m=document.cookie.match(new RegExp(SK+'=([^;]+)'));if(m)return m[1];const v=genVid();document.cookie=SK+'='+v+';path=/;max-age=31536000;SameSite=Lax';return v}}
function ldAsgn(){try{const s=localStorage.getItem(AK);return s?JSON.parse(s):{}}catch(e){return{}}}
function svAsgn(){try{localStorage.setItem(AK,JSON.stringify(asgn))}catch(e){}}
function hash(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h&=h}return Math.abs(h)}
function asgnVar(eid,alloc,fv){if(isPM&&fv){console.log('[CRO] Forced:',fv);return fv}if(asgn[eid])return asgn[eid];const bk=hash(vid+':'+eid)%100/100;const vr=bk<alloc?'B':'A';if(!isPM){asgn[eid]=vr;svAsgn()}console.log('[CRO]',eid,'->',vr);return vr}
async function fetchCfg(){try{const url=isPM&&pTok?'/apps/cro-proxy/preview/'+pTok:'/apps/cro-proxy/config?shop='+encodeURIComponent(cfg.shop);console.log('[CRO] Fetch:',url);const r=await fetch(url,{headers:{Accept:'application/json'}});if(!r.ok){console.warn('[CRO] Fail:',r.status);return}const d=await r.json();if(d.preview)console.log('[CRO] PREVIEW MODE');console.log('[CRO] Experiments:',d.experiments?.length||0);if(d.experiments?.length)renderExps(d.experiments,d.preview)}catch(e){console.error('[CRO] Error:',e)}}
function renderExps(exps,prev){exps.forEach(exp=>{if(exp.status!=='LIVE')return;const slots=document.querySelectorAll('[data-cro-slot="'+exp.slot_id+'"]');if(!slots.length){console.log('[CRO] No slot:',exp.slot_id);return}const vr=asgnVar(exp.id,exp.allocation||0.5,exp.forced_variant);const vc=exp.variants?.[vr];if(!vc){console.warn('[CRO] No content:',vr);return}slots.forEach((s,i)=>{console.log('[CRO] Render',exp.id,i+1+'/'+slots.length);renderSlot(s,vc,exp,vr)});if(!prev&&!isPM)track(exp.id,vr,'slot_view');else console.log('[CRO] Skip track:',exp.id)})}
function renderSlot(slot,c,exp,vr){const el=document.createElement('div');el.className='cro-experiment-content';el.dataset.experimentId=exp.id;el.dataset.variant=vr;if(typeof c==='string')el.innerHTML=c;else if(c.html)el.innerHTML=c.html;else if(c.text)el.textContent=c.text;else{el.dataset.payload=JSON.stringify(c);el.textContent=c.display||''}slot.innerHTML='';slot.appendChild(el);if(c.styles){const st=document.createElement('style');st.textContent=c.styles;slot.appendChild(st)}}
async function track(eid,vr,et,md={}){try{await fetch('/apps/cro-proxy/event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({experiment_id:eid,variant:vr,event_type:et,cro_vid:vid,path:location.pathname,timestamp:Date.now(),...md})});console.log('[CRO] Track:',et,eid)}catch(e){console.warn('[CRO] Track fail:',e)}}
window.CRORuntime={version:V,trackEvent:(et,md)=>Object.keys(asgn).forEach(eid=>track(eid,asgn[eid],et,md)),getVisitorId:()=>vid,getAssignments:()=>({...asgn})};
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init()})();
